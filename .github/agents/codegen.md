# Code Generation & Projen

## Projen (Project Configuration)

This monorepo uses [Projen](https://projen.io/) for infrastructure-as-code project management. All project config (package.json, tsconfig, vitest config, etc.) is generated from `.projenrc.ts`.

**Rules:**
- Edit `.projenrc.ts` (or files in `projenrc/`) to change project structure, deps, or config.
- Run `pnpm default` after any change -- this synthesizes all managed files.
- Files with `// ~~ Generated by projen` headers must not be edited manually.

### Adding a new package

1. Add the package definition in `.projenrc.ts` using `TypeScriptLibProject`.
2. Set `workspaceDeps` for internal dependencies and `workspacePeerDeps` for peer relationships.
3. Run `pnpm default` to generate the package scaffolding.

## Code Generation (AWS Client Wrappers)

The `packages/client-*` packages are auto-generated from AWS SDK v3 client definitions. **Never edit files in `packages/client-*/src/`** -- they will be overwritten.

### Adding a new AWS client

```bash
# 1. Add the service definition to the registry
#    Edit scripts/client-singularities.ts -- add description + commandToTest

# 2. If the SDK package name needs normalization (e.g., apigatewayv2 -> api-gateway-v2),
#    update scripts/utils.ts

# 3. Regenerate project structure
pnpm default

# 4. Generate the client wrapper code (interactive CLI)
pnpm codegen-client

# 5. Format the generated code
pnpm eslint --fix
```

### What gets generated

For each client, the codegen produces:

| File | Contents |
|---|---|
| `{Service}Service.ts` | Service interface, factory, Tag class with `defaultLayer`/`layer`/`baseLayer` |
| `{Service}ServiceConfig.ts` | Configuration layer for the AWS SDK client |
| `{Service}ClientInstance.ts` | Client instance layer wrapping the raw SDK client |
| `Errors.ts` | Tagged error types derived from SDK `ServiceException` subclasses |
| `index.ts` | Public re-exports |

### Modifying generated client behavior

If you need to customize a generated client (e.g., `client-s3` has extra deps like `@aws-sdk/s3-request-presigner`), add special-case logic in `.projenrc.ts` rather than editing the generated source.
